import logging
from django.shortcuts import render, get_object_or_404, redirect
from django.contrib import messages
from django.db.models import Q
from django.utils.dateparse import parse_date
from django.utils import timezone  # Import timezone
from .models import Feedback, FeedbackStatusHistory, FeedbackCategory
from .forms import FeedbackCategoryForm
from apps.notifications.services import NotificationService  # <--- Import Service

# Logger
logger = logging.getLogger(__name__)

# --- PH·∫¶N 1: QU·∫¢N L√ù PH·∫¢N H·ªíI ---

def feedback_list(request):
    """
    M√†n h√¨nh danh s√°ch ph·∫£n h·ªìi cho BQL
    """
    feedbacks = Feedback.objects.select_related('resident', 'apartment', 'category').order_by('-created_at')
    
    # L·∫•y tham s·ªë Filter
    status = request.GET.get('status')
    category_id = request.GET.get('category')
    q = request.GET.get('q')
    date_from = request.GET.get('date_from')
    date_to = request.GET.get('date_to')

    # √Åp d·ª•ng Filter
    if status:
        feedbacks = feedbacks.filter(status=status)
    if category_id:
        feedbacks = feedbacks.filter(category_id=category_id)
    if q:
        feedbacks = feedbacks.filter(
            Q(title__icontains=q) | 
            Q(code__icontains=q) |
            Q(resident__full_name__icontains=q) |
            Q(apartment__apartment_code__icontains=q)
        )
    if date_from:
        d_from = parse_date(date_from)
        if d_from:
            feedbacks = feedbacks.filter(created_at__date__gte=d_from)
    if date_to:
        d_to = parse_date(date_to)
        if d_to:
            feedbacks = feedbacks.filter(created_at__date__lte=d_to)

    context = {
        'feedbacks': feedbacks,
        'categories': FeedbackCategory.objects.all(),
        'status_choices': Feedback.STATUS_CHOICES,
        'request_data': request.GET
    }
    return render(request, 'feedback/feedback_list.html', context)

def feedback_detail(request, pk):
    """
    Chi ti·∫øt ph·∫£n h·ªìi & C·∫≠p nh·∫≠t tr·∫°ng th√°i
    """
    feedback = get_object_or_404(Feedback, pk=pk)
    
    if request.method == 'POST':
        new_status = request.POST.get('status')
        note = request.POST.get('note')
        
        if new_status and new_status != feedback.status:
            try:
                print(f"üîÑ [UPDATE] ƒêang c·∫≠p nh·∫≠t Feedback {feedback.code} t·ª´ {feedback.status} -> {new_status}")
                
                # 1. L∆∞u l·ªãch s·ª≠
                FeedbackStatusHistory.objects.create(
                    feedback=feedback,
                    old_status=feedback.status,
                    new_status=new_status,
                    changed_by=request.user,
                    note=note
                )
                
                # L∆∞u tr·∫°ng th√°i c≈© ƒë·ªÉ so s√°nh (n·∫øu c·∫ßn logic ph·ª©c t·∫°p h∆°n)
                old_status = feedback.status
                
                # 2. C·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªõi
                feedback.status = new_status
                feedback.internal_note = note
                if new_status == 'DONE':
                    feedback.resolved_at = timezone.now()
                
                feedback.save()
                
                # --- G·ªåI NOTIFICATION SERVICE ---
                # G·ª≠i th√¥ng b√°o cho c∆∞ d√¢n
                print("üöÄ [NOTIFY] ƒêang g·ªçi service g·ª≠i th√¥ng b√°o...")
                NotificationService.send_feedback_notification(feedback, old_status, new_status)
                # --------------------------------------------

                messages.success(request, f"C·∫≠p nh·∫≠t th√†nh c√¥ng: {feedback.get_status_display()}")
                
            except Exception as e:
                logger.error(f"L·ªói update feedback: {e}")
                print(f"‚ùå L·ªói update feedback: {e}")
                messages.error(request, "C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t.")
            
            return redirect('feedback_detail', pk=pk)

    return render(request, 'feedback/feedback_detail.html', {'feedback': feedback})


# --- PH·∫¶N 2: QU·∫¢N L√ù DANH M·ª§C ---

def category_list(request):
    """Danh s√°ch danh m·ª•c & Form t·∫°o m·ªõi/S·ª≠a"""
    categories = FeedbackCategory.objects.all().order_by('created_at')
    
    if request.method == 'POST':
        cat_id = request.POST.get('cat_id')
        if cat_id:
            cat_instance = get_object_or_404(FeedbackCategory, pk=cat_id)
            form = FeedbackCategoryForm(request.POST, instance=cat_instance)
            action_msg = "C·∫≠p nh·∫≠t"
        else:
            form = FeedbackCategoryForm(request.POST)
            action_msg = "T·∫°o m·ªõi"
            
        if form.is_valid():
            form.save()
            messages.success(request, f"{action_msg} danh m·ª•c th√†nh c√¥ng!")
            return redirect('category_list')
        else:
            messages.error(request, "Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.")
    else:
        form = FeedbackCategoryForm()

    return render(request, 'feedback/category_list.html', {
        'categories': categories,
        'form': form
    })

def category_delete(request, pk):
    """X√≥a danh m·ª•c & Chuy·ªÉn d·ªØ li·ªáu c≈© sang 'Kh√°c'"""
    category = get_object_or_404(FeedbackCategory, pk=pk)
    
    if not category.is_deletable:
        messages.error(request, "Danh m·ª•c n√†y l√† m·∫∑c ƒë·ªãnh h·ªá th·ªëng, kh√¥ng th·ªÉ x√≥a!")
        return redirect('category_list')

    if request.method == 'POST':
        try:
            other_cat = FeedbackCategory.objects.get(code='OTHER')
            count = category.feedbacks.count()
            
            if count > 0:
                category.feedbacks.update(category=other_cat)
                messages.warning(request, f"ƒê√£ chuy·ªÉn {count} ph·∫£n h·ªìi c≈© sang danh m·ª•c 'Kh√°c'.")
            
            category.delete()
            messages.success(request, f"ƒê√£ x√≥a danh m·ª•c {category.name}.")
            
        except FeedbackCategory.DoesNotExist:
            messages.error(request, "L·ªói: Kh√¥ng t√¨m th·∫•y danh m·ª•c 'Kh√°c' ƒë·ªÉ chuy·ªÉn d·ªØ li·ªáu.")
            
    return redirect('category_list')    