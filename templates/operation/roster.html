{% extends "base.html" %}
{% load static %}

{% block title %}X·∫øp l·ªãch tr·ª±c - Operation{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>
    .fc-event { cursor: pointer; }
    /* Style cho c√°c m·ª•c nh√¢n vi√™n b√™n tr√°i */
    #external-events .fc-event {
        margin: 5px 0;
        padding: 8px 12px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-left: 4px solid #0d6efd;
        color: #333;
        cursor: move;
        border-radius: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    #external-events .fc-event:hover {
        background-color: #f8f9fa;
        transform: translateX(2px);
        transition: all 0.2s;
    }
    .trash-zone {
        border: 2px dashed #dc3545;
        background-color: #fff5f5;
        color: #dc3545;
        text-align: center;
        padding: 15px;
        margin-top: 15px;
        border-radius: 5px;
        transition: all 0.3s;
    }
    .trash-zone:hover {
        background-color: #ffe0e0;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 mb-5">
    <h3 class="mb-3 text-primary"><i class="fas fa-calendar-alt"></i> B·∫£ng ph√¢n ca tr·ª±c</h3>
    
    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-tools"></i> C√¥ng c·ª•</h5>
                </div>
                <div class="card-body bg-light">
                    <div class="mb-3">
                        <label class="form-label fw-bold text-dark">1. Ch·ªçn Ca tr·ª±c √°p d·ª•ng:</label>
                        <select id="shift-selector" class="form-select border-primary">
                            <option value="">-- ƒêang t·∫£i d·ªØ li·ªáu... --</option>
                        </select>
                        <small class="text-muted">Ch·ªçn ca tr∆∞·ªõc khi k√©o nh√¢n vi√™n.</small>
                    </div>
                    <hr>
                    
                    <label class="form-label fw-bold text-dark">2. Danh s√°ch Nh√¢n vi√™n:</label>
                    <div id="external-events" style="max-height: 400px; overflow-y: auto; padding: 2px;">
                        <div class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            ƒêang t·∫£i...
                        </div>
                    </div>

                    <div class="trash-zone" id="trash-zone">
                        <i class="fas fa-trash-alt fa-lg mb-1"></i>
                        <div>K√©o l·ªãch v√†o ƒë√¢y ƒë·ªÉ X√ìA</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card shadow-sm h-100">
                <div class="card-body p-2">
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/vi.js'></script> <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const Calendar = FullCalendar.Calendar;
        const Draggable = FullCalendar.Draggable;
        
        const containerEl = document.getElementById('external-events');
        const calendarEl = document.getElementById('calendar');
        const shiftSelect = document.getElementById('shift-selector');

        // 1. Load D·ªØ li·ªáu ngu·ªìn (Nh√¢n vi√™n & Ca tr·ª±c)
        axios.get('/operation/api/master-data/').then(response => {
            const { staffs, shifts } = response.data;
            
            // Render Select Ca tr·ª±c
            if(shifts.length > 0){
                shiftSelect.innerHTML = shifts.map(s => 
                    `<option value="${s.id}">${s.name} (${s.start_time.slice(0,5)} - ${s.end_time.slice(0,5)})</option>`
                ).join('');
            } else {
                shiftSelect.innerHTML = '<option value="">Ch∆∞a c√≥ c·∫•u h√¨nh Ca tr·ª±c</option>';
            }

            // Render Danh s√°ch nh√¢n vi√™n (Draggable)
            if(staffs.length > 0) {
                containerEl.innerHTML = staffs.map(s => `
                    <div class='fc-event' data-staff-id='${s.id}' data-staff-name='${s.full_name}'>
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-user-tag text-primary me-2"></i>${s.full_name}</span>
                            <span class="badge bg-secondary" style="font-size: 0.7em">${s.team}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                containerEl.innerHTML = '<div class="alert alert-warning">Ch∆∞a c√≥ nh√¢n vi√™n Active</div>';
            }

            // K√≠ch ho·∫°t t√≠nh nƒÉng K√©o (Draggable) cho danh s√°ch nh√¢n vi√™n
            new Draggable(containerEl, {
                itemSelector: '.fc-event',
                eventData: function(eventEl) {
                    return {
                        title: eventEl.getAttribute('data-staff-name'),
                        extendedProps: {
                            staff_id: eventEl.getAttribute('data-staff-id')
                        }
                    };
                }
            });
        }).catch(err => console.error("L·ªói load master data:", err));

        // 2. Kh·ªüi t·∫°o L·ªãch (Calendar)
        const calendar = new Calendar(calendarEl, {
            locale: 'vi', // Ng√¥n ng·ªØ ti·∫øng Vi·ªát
            initialView: 'dayGridMonth',
            height: 'auto',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            editable: true,     // Cho ph√©p k√©o s·ª≠a l·ªãch ƒë√£ c√≥
            droppable: true,    // Cho ph√©p th·∫£ nh√¢n vi√™n t·ª´ b√™n ngo√†i v√†o
            events: '/operation/api/rosters/', // Load s·ª± ki·ªán t·ª´ API

            // --- X·ª¨ L√ù KHI TH·∫¢ NH√ÇN VI√äN V√ÄO (T·∫†O M·ªöI) ---
            drop: function(info) {
                const shiftId = shiftSelect.value;
                if (!shiftId) {
                    alert("‚ö†Ô∏è Vui l√≤ng CH·ªåN CA TR·ª∞C ·ªü b√™n tr√°i tr∆∞·ªõc khi k√©o nh√¢n vi√™n!");
                    info.draggedEl.parentNode.removeChild(info.draggedEl); // Ho√†n t√°c thao t√°c k√©o
                    return;
                }
            },

            eventReceive: function(info) {
                // Khi s·ª± ki·ªán ƒë∆∞·ª£c th·∫£ th√†nh c√¥ng -> G·ªçi API l∆∞u
                const staffId = info.event.extendedProps.staff_id;
                const shiftId = shiftSelect.value;
                const date = info.event.startStr.split('T')[0]; // L·∫•y ng√†y YYYY-MM-DD

                axios.post('/operation/api/rosters/', {
                    staff: staffId,
                    shift: shiftId,
                    date: date
                }, {
                    headers: {'X-CSRFToken': '{{ csrf_token }}'}
                }).then(res => {
                    // C·∫≠p nh·∫≠t l·∫°i m√†u s·∫Øc v√† ID t·ª´ server tr·∫£ v·ªÅ
                    info.event.setProp('title', res.data.title);
                    info.event.setProp('backgroundColor', res.data.color);
                    info.event.setProp('borderColor', res.data.color);
                    info.event.setExtendedProp('id', res.data.id); 
                    
                    // Th√¥ng b√°o nh·ªè (Toast) ho·∫∑c console
                    console.log("ƒê√£ l∆∞u l·ªãch th√†nh c√¥ng!");
                }).catch(err => {
                    alert("‚ùå L·ªói: " + (err.response?.data?.detail || "Kh√¥ng th·ªÉ l∆∞u l·ªãch!"));
                    info.event.remove(); // X√≥a kh·ªèi giao di·ªán n·∫øu l∆∞u l·ªói
                });
            },

            // --- X·ª¨ L√ù KHI K√âO S·ª¨A NG√ÄY (C·∫¨P NH·∫¨T) ---
            eventDrop: function(info) {
                const rosterId = info.event.id || info.event.extendedProps.id;
                const newDate = info.event.startStr.split('T')[0];

                if (!confirm(`B·∫°n mu·ªën ƒë·ªïi l·ªãch c·ªßa ${info.event.title} sang ng√†y ${newDate}?`)) {
                    info.revert(); // N·∫øu ch·ªçn Cancel th√¨ quay l·∫°i c≈©
                    return;
                }

                axios.patch(`/operation/api/rosters/${rosterId}/`, {
                    date: newDate
                }, {
                    headers: {'X-CSRFToken': '{{ csrf_token }}'}
                }).then(() => {
                    console.log("C·∫≠p nh·∫≠t ng√†y th√†nh c√¥ng");
                }).catch(err => {
                    alert("L·ªói c·∫≠p nh·∫≠t: " + (err.response?.data?.detail || "Kh√¥ng r√µ"));
                    info.revert();
                });
            },

            // --- X·ª¨ L√ù X√ìA (CLICK V√ÄO S·ª∞ KI·ªÜN) ---
            eventClick: function(info) {
                if (confirm(`üóëÔ∏è B·∫°n mu·ªën X√ìA l·ªãch tr·ª±c c·ªßa: ${info.event.title}?`)) {
                    const rosterId = info.event.id || info.event.extendedProps.id;
                    if(rosterId) {
                        axios.delete(`/operation/api/rosters/${rosterId}/`, {
                             headers: {'X-CSRFToken': '{{ csrf_token }}'}
                        }).then(() => {
                            info.event.remove();
                        });
                    }
                }
            }
        });

        calendar.render();
    });
</script>
{% endblock %}