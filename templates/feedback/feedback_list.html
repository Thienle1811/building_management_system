{% extends 'base.html' %}
{% load humanize %}

{% block title %}Quản lý Phản hồi cư dân{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary"><i class="fas fa-bullhorn me-2"></i>Phản hồi & Báo cáo</h2>
    <div class="text-muted small">
        Quản lý các yêu cầu, khiếu nại từ cư dân
    </div>
</div>

<div class="card mb-4 shadow-sm border-0">
    <div class="card-body bg-light">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted">Tìm kiếm</label>
                <input type="text" name="q" class="form-control" 
                       placeholder="Mã, Tiêu đề, Căn hộ..." value="{{ request_data.q }}">
            </div>

            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted">Danh mục</label>
                <select name="category" class="form-select">
                    <option value="">-- Tất cả --</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if request_data.category == cat.id|stringformat:"i" %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted">Trạng thái</label>
                <select name="status" class="form-select">
                    <option value="">-- Tất cả --</option>
                    {% for key, val in status_choices %}
                        <option value="{{ key }}" {% if request_data.status == key %}selected{% endif %}>
                            {{ val }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted">Ngày báo cáo</label>
                <div class="input-group">
                    <input type="date" name="date_from" class="form-control" value="{{ request_data.date_from }}" title="Từ ngày">
                    <span class="input-group-text">-</span>
                    <input type="date" name="date_to" class="form-control" value="{{ request_data.date_to }}" title="Đến ngày">
                </div>
            </div>

            <div class="col-md-2 d-grid align-items-end">
                <button type="submit" class="btn btn-primary fw-bold">
                    <i class="fas fa-filter me-1"></i> Lọc
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0 align-middle">
                <thead class="table-dark">
                    <tr>
                        <th class="ps-3">Mã FB</th>
                        <th>Thời gian</th>
                        <th>Căn hộ</th>
                        <th>Danh mục</th>
                        <th>Tiêu đề</th>
                        <th>Độ ưu tiên</th>
                        <th>Trạng thái</th>
                        <th class="text-center">Chi tiết</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fb in feedbacks %}
                    <tr>
                        <td class="fw-bold text-primary ps-3">{{ fb.code }}</td>
                        <td class="small text-muted">
                            {{ fb.created_at|date:"d/m/Y" }}<br>
                            {{ fb.created_at|date:"H:i" }}
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">
                                {{ fb.apartment.apartment_code }}
                            </span>
                            <div class="small text-muted mt-1">{{ fb.resident.full_name }}</div>
                        </td>
                        <td>{{ fb.category.name }}</td>
                        <td>
                            <div class="text-truncate" style="max-width: 250px;" title="{{ fb.title }}">
                                {{ fb.title }}
                            </div>
                        </td>
                        <td>
                            {% if fb.priority == 'URGENT' %}
                                <span class="badge bg-danger">Khẩn cấp</span>
                            {% elif fb.priority == 'HIGH' %}
                                <span class="badge bg-warning text-dark">Cao</span>
                            {% else %}
                                <span class="text-muted small">Bình thường</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if fb.status == 'PENDING' %}
                                <span class="badge bg-secondary">Chờ tiếp nhận</span>
                            {% elif fb.status == 'PROCESSING' %}
                                <span class="badge bg-primary">Đang xử lý</span>
                            {% elif fb.status == 'DONE' %}
                                <span class="badge bg-success">Hoàn thành</span>
                            {% else %}
                                <span class="badge bg-dark">Đã hủy</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <a href="{% url 'feedback_detail' fb.id %}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">
                            <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i><br>
                            Không tìm thấy phản hồi nào.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer text-muted small">
        Tổng số: <strong>{{ feedbacks.count }}</strong> phản hồi.
    </div>
</div>
{% endblock %}